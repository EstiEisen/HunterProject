import { Component, OnInit } from '@angular/core';
import { Router, ActivatedRoute } from '@angular/router';

import { UserSessionService } from '../../../../shared/_services/user-session.service';
import { GeneralHttpService } from '../../../_services/http/general-http.service';
import { EmployerService } from '../../../_services/http/employer.service';

import { Employer } from '../../../../shared/_models/employer.model';
import { Bank } from '../../../../shared/_models/bank.model';
import { BankBranch } from '../../../../shared/_models/bank-branch.model';

@Component({
  selector: 'app-employer-form',
  templateUrl: './employer-form.component.html',
  styleUrls: ['./employer-form.component.css']
})
export class EmployerFormComponent implements OnInit {

  employer = new Employer();
  banks: Bank[] = [];
  bankBranches: BankBranch[] = [];

  isSubmitting: boolean;
  isSuccessful: boolean;

  constructor(private router: Router, private route: ActivatedRoute, private userSession: UserSessionService,
              private generalHttp: GeneralHttpService, private employerService: EmployerService) {}

  ngOnInit() {
    this.generalHttp.getBanks(this.userSession.getUser().token).then(response => this.banks = response);

    this.route.params.subscribe(message => message['id'] ? this.employerService.getEmployer(+message['id'], this.userSession.getToken())
    .then(response => this.employer = response) : '');
  }

  loadBankBranches(bankID: number): void {
    if (bankID) {
      this.generalHttp.getBankBranches(bankID, this.userSession.getUser().token).then(response => this.bankBranches = response);
    }
  }

  submit(isValid: boolean): void {
    if (isValid) {
      this.isSubmitting = true;

      this.employerService.newEmployer(this.employer, this.userSession.getToken())
      .then(response => setTimeout(() => this.handleResponse(response), 2000));
    }
  }

  private handleResponse(response: Employer): void {
    if (response['id']) {
      sessionStorage.setItem('new-employer', JSON.stringify(response));
      this.router.navigate(['/settings/employers']);
    }

    this.isSuccessful = false;
    this.isSubmitting = false;
  }
}
