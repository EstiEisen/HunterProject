import { Component, OnInit, Input, Output, EventEmitter } from '@angular/core';
import { trigger, state, style, animate, transition } from '@angular/animations';

import { UserSessionService } from '../../../shared/_services/user-session.service';
import { EmployerService } from '../../_services/http/employer.service';
import { ProcessService } from '../../_services/http/process.service';
import { ProcessFileService } from '../../_services/http/process-file.service';

import { Process } from '../../../shared/_models/process.model';
import { Employer } from '../../../shared/_models/employer.model';

import { MONTHS } from '../../../shared/_const/months';

@Component({
  selector: 'app-process-upload-form',
  templateUrl: './process-upload-form.component.html',
  styleUrls: ['./process-upload-form.component.css'],
  animations: [
    trigger('fadeIn', [
      state('inactive', style({
        opacity: '0',
        display: 'none'
      })),
      state('active', style({
        opacity: '1',
        display: '*'
      })),
      transition('inactive => active', animate('400ms ease-in')),
      transition('active => inactive', animate('400ms ease-out'))
    ])
  ]
})
export class ProcessUploadFormComponent implements OnInit {

  @Output() stepChange = new EventEmitter<{ index: number, process: Process }>();
  @Input() process: Process;

  employers: Employer[] = [];
  readonly months = MONTHS;
  readonly currentYear = new Date().getFullYear();

  file: File = <File>{};
  selectedUploadMethod: 'xml' | 'excel' | 'manual';

  uploadProgressPercent: number;
  isFileUploaded = false;

  constructor(private userSession: UserSessionService, private employerService: EmployerService, private processService: ProcessService,
              private processFileService: ProcessFileService) {}

  ngOnInit() {
    this.employerService.getEmployers(this.userSession.getToken()).then(response => this.employers = response);
  }

  checkFileType(): boolean {
    if (!this.file.name  || !this.selectedUploadMethod) {
      return true;
    }

    const ext = this.file.name.substr(this.file.name.indexOf('.') + 1);

    switch (this.selectedUploadMethod) {
      case 'xml':
        if (['xml', 'XML', 'dat', 'DAT'].indexOf(ext) !== -1) {
          return true;
        }
        break;
      case 'excel':
        if (ext === 'xls' || ext === 'xlsx') {
          return true;
        }
        break;
      case 'manual':
        return true;
    }

    return false;
  }

  uploadFile(isValid: boolean): void {

    // if (isValid) {
    //   this.uploadProgressPercent = 1;
    //   this.processFileService.uploadFile(this.process, this.file, this.userSession.getToken())
    //     .then(response => this.setUploadFile(response['processNumber']));
    // }
  }

  private setUploadFile(processID: number): void {
    this.process.id = processID;

    const intervalInstance = setInterval(() => this.processFileService.getFileUploadStatus(this.process.id, this.userSession.getToken())
    .then(response => this.handleCheckFileStatus(response['progressPercent'], intervalInstance)), 10000);
  }

  private handleCheckFileStatus(percent: number, intervalInstance): void {
    this.uploadProgressPercent = percent > 0 ? percent : 1 ;
    if (percent === 100) {
      clearInterval(intervalInstance);
      setTimeout(() => this.isFileUploaded = true, 3000);
    }
  }

  setStepChange(index: number): void {
    this.stepChange.emit({ index: index, process: this.process });
  }
}
